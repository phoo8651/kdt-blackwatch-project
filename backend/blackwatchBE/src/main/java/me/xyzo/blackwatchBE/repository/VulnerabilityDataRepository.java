package me.xyzo.blackwatchBE.repository;

import me.xyzo.blackwatchBE.document.VulnerabilityDataDocument;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.mongodb.repository.MongoRepository;
import org.springframework.data.mongodb.repository.Query;
import org.springframework.stereotype.Repository;

import java.util.List;

@Repository
public interface VulnerabilityDataRepository extends MongoRepository<VulnerabilityDataDocument, String> {

    // CVE로 검색 (cveIds 필드명 변경)
    @Query("{'cveIds': {$regex: ?0, $options: 'i'}}")
    Page<VulnerabilityDataDocument> findByCveIdsContaining(String cveId, Pageable pageable);

    // CVSS 범위 검색 (String 타입으로 변경)
    @Query("{ $and: [ " +
            "?#{[0] == null ? {} : {'cvss': {$regex: '^[0-' + ?0.substring(0,1) + ']\\\\.[0-9]+$'}}}, " +
            "?#{[1] == null ? {} : {'cvss': {$regex: '^[0-' + ?1.substring(0,1) + ']\\\\.[0-9]+$'}}} " +
            "] }")
    Page<VulnerabilityDataDocument> findByCvssRange(String cvssMin, String cvssMax, Pageable pageable);

    // 복합 검색을 위한 커스텀 쿼리 (cveIds 필드명 변경)
    @Query("{ $and: [ " +
            "?#{[0] == null ? {} : {'uploadDate': {$gte: ?0}}}, " +
            "?#{[1] == null ? {} : {'uploadDate': {$lte: ?1}}}, " +
            "?#{[2] == null ? {} : {'host': {$regex: ?2, $options: 'i'}}}, " +
            "?#{[3] == null ? {} : {'path': {$regex: ?3, $options: 'i'}}}, " +
            "?#{[4] == null ? {} : {'title': {$regex: ?4, $options: 'i'}}}, " +
            "?#{[5] == null ? {} : {'author': {$regex: ?5, $options: 'i'}}}, " +
            "?#{[6] == null ? {} : {'cveIds': {$regex: ?6, $options: 'i'}}}, " +
            "?#{[7] == null ? {} : {'cvss': {$regex: ?7, $options: 'i'}}}, " +
            "?#{[8] == null ? {} : {'cvss': {$regex: ?8, $options: 'i'}}}, " +
            "?#{[9] == null ? {} : {'vulnerabilityClass': {$regex: ?9, $options: 'i'}}} " +
            "] }")
    Page<VulnerabilityDataDocument> findWithFilters(
            String from, String to, String host,
            String pathContains, String titleContains, String author,
            String cveIds, String cvssMin, String cvssMax, String vulnClass,
            Pageable pageable);

    // 전체 텍스트 검색
    @Query("{ $or: [ " +
            "{'title': {$regex: ?0, $options: 'i'}}, " +
            "{'article': {$regex: ?0, $options: 'i'}}, " +
            "{'products': {$regex: ?0, $options: 'i'}} " +
            "] }")
    Page<VulnerabilityDataDocument> findByTextSearch(String searchText, Pageable pageable);

    // 취약점 클래스로 검색
    Page<VulnerabilityDataDocument> findByVulnerabilityClassIn(List<String> vulnerabilityClasses, Pageable pageable);

    // 제품으로 검색
    Page<VulnerabilityDataDocument> findByProductsIn(List<String> products, Pageable pageable);

    // 익스플로잇 기법으로 검색
    Page<VulnerabilityDataDocument> findByExploitationTechniqueIn(List<String> techniques, Pageable pageable);
}